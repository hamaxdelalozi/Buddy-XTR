





































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































import axios from 'axios';
import config from '../../config.cjs';
import fs from 'fs';
import path from 'path';

const toimageCommand = async (m, Matrix) => {
  try {
    const prefix = config.PREFIX;
    const cmd = m.body.startsWith(prefix) ? m.body.slice(prefix.length).split(' ')[0].toLowerCase() : '';
    
    if (cmd !== 'toimage') return;

    const newsletterJID = config.NEWSLETTER_JID || '120363313938933929@newsletter';
    const senderName = m.pushName || "User";
    const senderJid = m.sender;

    if (!m.quoted) {
      return await Matrix.sendMessage(m.from, {
        text: ' Please reply to a sticker to convert it to image.',
        mentions: [senderJid],
        contextInfo: {
          mentionedJid: [senderJid],
          forwardingScore: 999,
          isForwarded: true,
          participant: newsletterJID,
          stanzaId: m.id,
          quotedMessage: {
            conversation: "Sticker to Image Conversion"
          }
        }
      });
    }

    const quotedMsg = m.quoted.message;
    
    if (!quotedMsg.stickerMessage) {
      return await Matrix.sendMessage(m.from, {
        text: ' The replied message is not a sticker.',
        mentions: [senderJid],
        contextInfo: {
          mentionedJid: [senderJid],
          forwardingScore: 999,
          isForwarded: true,
          participant: newsletterJID,
          stanzaId: m.id,
          quotedMessage: {
            conversation: "Sticker to Image Conversion"
          }
        }
      });
    }

    const stickerInfo = quotedMsg.stickerMessage;
    
    // Check if sticker is animated
    if (stickerInfo.isAnimated) {
      return await Matrix.sendMessage(m.from, {
        text: ' Animated stickers cannot be converted to images.',
        mentions: [senderJid],
        contextInfo: {
          mentionedJid: [senderJid],
          forwardingScore: 999,
          isForwarded: true,
          participant: newsletterJID,
          stanzaId: m.id,
          quotedMessage: {
            conversation: "Sticker to Image Conversion"
          }
        }
      });
    }

    // Download the sticker
    const mediaUrl = await Matrix.downloadAndSaveMediaMessage(quotedMsg.stickerMessage, {
      stream: false,
      saveToTemp: true
    });

    // Convert to image
    await Matrix.sendMessage(m.from, {
      image: fs.readFileSync(mediaUrl),
      caption: 'Here\'s your image converted from sticker!',
      mentions: [senderJid],
      contextInfo: {
        mentionedJid: [senderJid],
        forwardingScore: 999,
        isForwarded: true,
        participant: newsletterJID,
        stanzaId: m.id,
        quotedMessage: {
          conversation: "Sticker to Image Conversion"
        }
      }
    });

    // Clean up temp file
    fs.unlinkSync(mediaUrl);

  } catch (error) {
    console.error('Error in toimage command:', error);
    await Matrix.sendMessage(m.from, {
      text: ` Error: ${error.message}`,
      contextInfo: {
        forwardingScore: 999,
        isForwarded: true,
        participant: newsletterJID
      }
    });
  }
};

export default toimageCommand;
